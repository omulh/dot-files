#! /bin/sh

if [[ -z $1 ]]; then
    echo "No file provided!" >&2   
    exit 1
fi

if [[ $1 == -i || $1 == --info ]]; then
    if [[ -z $2 ]]; then
        echo "No file provided!" >&2   
        exit 1
    fi
    giveHint=true
    targetFile="$2"
else
    targetFile="$1"
fi

if [[ ! -r $targetFile ]]; then
    echo "File doesn't exist!" >&2
    exit 1
fi

# Get the mime type of the given file from xdg-mime
mimeType=$(xdg-mime query filetype "$targetFile")

# Get info on the default app for the obtained mime type
# from xdg-mime, reversing the order of the resulting lines
xdgMimeOutput=$(XDG_UTILS_DEBUG_LEVEL=2 xdg-mime query default $mimeType 2>&1 | tac)
# If a default app was found, its .desktop file will be found 
# on the first line of the (reversed) xdg-mime output
desktopFile=$(echo "$xdgMimeOutput" | sed -n '1p')

# If a default app was found
if [[ $desktopFile == *.desktop ]]; then
    # Open the file if indicated
    if [[ -z $giveHint ]]; then
        # Only try to use .desktop files that are in the local directory
        if [[ -r $HOME/.local/share/applications/$desktopFile ]]; then
            # Check if the default app is a terminal app
            isTerminalApp=$(grep "Terminal=" "$HOME/.local/share/applications/$desktopFile")
            isTerminalApp=${isTerminalApp#Terminal=}
            if [[ $isTerminalApp == true ]]; then
                kitty --detach xdg-open "$targetFile"
            else
                xdg-open "$targetFile" &
            fi
        else
            echo "Desktop file for the default app ($desktopFile) not found in the local directory" >&2
        fi
    # Otherwise, just give some feedback about the default app
    else
        # The file in which the default app is defined will be
        # found on the second line of the (reversed) xdg-mime output
        defaultAppSource=$(echo "$xdgMimeOutput" | sed -n '2p')
        # Check if '/home' is present in the result, which would mean
        # the default is defined by the user, and not system-wide
        if [[ -n $(echo $defaultAppSource | grep '/home.*') ]]; then
            # Check if the .desktop file is present in the default dir.
            # and if so, extract the application's name from it
            if [[ -r $HOME/.local/share/applications/$desktopFile ]]; then
                appName=$(grep '^Name=' "$HOME/.local/share/applications/$desktopFile")
                appName=${appName#Name=}
            fi
            hint=''
        else
            # Extract the app name from the .desktop file's name
            appName=${desktopFile%.desktop}
            hint=' (not user defined)'
        fi
        echo "$mimeType files are opened with $appName by default$hint" >&2
    fi
else
    echo "No default set for $mimeType files" >&2
fi
