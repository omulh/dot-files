#!/bin/sh

# Get info on the available audio sources from pactl
pactlAvailableSources=$(pactl list sources | grep -E -B 45 ', available|availability unknown' | grep -A 20 'Audio/Source')

# Get the ID for the available sources,
# which should be found in a line like this:
# object.id = "64"
availableSourceIds=$(echo "$pactlAvailableSources" | grep 'object.id' | sed -r 's/[^0-9]*//g')

# Get the node nick for the available sources,
# which should be found in a line like this:
# node.nick = "Integrated Mic."
availableSourceNicks=$(echo "$pactlAvailableSources" | grep 'node.nick' | cut -d\" -f2)

# Get the node nick for the default source from wpctl inspect,
# and add a hint to it in the list of available sources
defaultSourceNick=$(wpctl inspect @DEFAULT_AUDIO_SOURCE@ | grep node.nick | cut -d\" -f2)
availableSourceNicks=$(echo "$availableSourceNicks" | sed "s/$defaultSourceNick/& (Active)/")

# Get the length of the longest string
maxLen="0"
while IFS= read -r line; do
    [[ "${#line}" -gt "$maxLen" ]] && maxLen="${#line}"
done <<< "$availableSourceNicks"
width=$((maxLen+=2))

# Create a fuzzel menu with the source nicks
fuzzelIdx=$(echo "$availableSourceNicks" | fuzzel --dmenu --index -p "Select an input: " -l 4 -w $width -x 15 -y 15 -P 8)

# If a selection was made, use wpctl to change
# to the corresponding source, by using its ID
if [[ -n $fuzzelIdx ]]; then
    selectedSourceId=$(echo $availableSourceIds | cut -d' ' -f$((fuzzelIdx + 1)))
    wpctl set-default $selectedSourceId
fi

# Update the status of the keyboard's mic. status LED
if [[ $(wpctl get-volume @DEFAULT_AUDIO_SOURCE@) == *[MUTED]* ]]; then
    brightnessctl -d platform::micmute -q s 1
else
    brightnessctl -d platform::micmute -q s 0
fi
