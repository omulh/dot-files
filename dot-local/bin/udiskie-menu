#! /bin/sh

rawInfo=$(
    udiskie-info -C -a --filter 'is_filesystem' \
                 --output '{device_file}:{id_label}:{id_type}:{is_mounted}:{mount_path}'
)

# If no device was found, send a notification and exit
if [[ -z $rawInfo ]]; then
    notify-send "No mountable device detected" "No devices with filesystem were detected by udiskie" 
    exit
fi

displayInfo=$(
    echo "$rawInfo" | \
    column --separator ':' --table \
           --table-columns 'DEVICE,LABEL,FS TYPE,MOUNTED,MOUNT POINT'
)

displayInfoLength=$(echo "$displayInfo" | wc -L)
[[ $displayInfoLength -gt 80 ]] && displayInfoLength=80

deviceSelection=$(
    echo "$displayInfo" | \
    fzf-popup $((displayInfoLength+10))x15 \
        --no-multi --margin 0,1,1 --accept-nth 1 \
        --input-label ' Mount or unmount a device ' \
        --input-border horizontal \
        --header-lines 1 \
        --header-border bottom \
        --color 'header:#7890a6' \
)

if [[ -n $deviceSelection ]]; then
    mountPath=$(echo "$rawInfo" | grep "$deviceSelection" | cut -d: -f5)
    if [[ -z $mountPath ]]; then
        udiskie-mount --quiet "$deviceSelection"
    else
        udiskie-umount --quiet "$mountPath"
    fi
fi
