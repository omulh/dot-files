#! /bin/sh

PREVIEW='
    mimeType=$(mime-type-query -q {})
    defaultApp=$(mime-default-query -q -o {appname} "$mimeType")

    if [[ -n $defaultApp ]]; then
        echo -e "  $defaultApp"
    else
        echo -e "  \033[2;33mNo default app set\033[0m"
    fi
'

selection=$(
    fd --base-directory "$HOME" | \
    fzf-popup \
        --no-multi --margin 0,1,1 \
        --prompt '~/' --input-label ' Search a file ' \
        --input-border horizontal \
        --preview-window nohidden,down,1 \
        --preview "$PREVIEW" --preview-border top \
        --preview-label ' Opens with ' --preview-label-pos 2 \
        --header-border bottom \
        --header 'Enter (open the file) â•± CTRL-F (show in lf)' \
        --bind 'ctrl-f:become(echo --lf {})' \
        --color 'preview-fg:#91a5c4' \
)

# If a selection was made
if [[ -n "$selection" ]]; then
    if [[ ! $selection =~ ^--lf ]]; then
        mime-open -q "$selection"
    else
        # Show the file in lf
        fileSelection=$(echo "$selection" | cut -d ' ' -f 2-)
        kitty --detach lf "$HOME/$fileSelection"
    fi
fi
